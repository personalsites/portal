!function(e){"use strict";const t=[54.514533,36.280053],o="Московская ул., 289, Калуга",n=[54.5635089,36.2609796],s="Калуга",r=["Куровской","Льва Толстого","Мстихино","с. Муратовского щебзавода","Калуга-2","Воротынск","с. Воскресенское","Анненки","Резвань","пос. Юбилейный","д. Бабенки","д. Городня","д. Канищево","д. Лихун","Колюпаново","пос. Ильинка","Пучково","Ромодановские дворики","с. Андреевское","с. Дворцы","с. Плетеневка","с. Росва","Тихонова Пустынь"],l=50,i=["rideTime","district","fullName","address","phone"];function a(e){const{address:t,phone:o}=function(e){const t=e.indexOf("+7");let o=-1!==t?e.slice(0,t):e;const n=o.lastIndexOf(",");return o=-1!==n?o.slice(0,n):o,{address:o,phone:-1!==t?e.slice(t):""}}(e[3]);return{rideTime:e[0],district:e[1],fullName:e[2],address:t,phone:o}}function c(e){return i.reduce(((t,o)=>t+e[o]),"")}function d(e){console.log("fullName",e);const[t,o,n]=e.split(" ");return`${t} ${o[0]}. ${n?`${n[0]}.`:""}`}function u(e,t){return{...e,geoObject:t}}function h(e){$(e).parent("li").addClass("active")}function p(e,t,o){return e.some((e=>o.district.toLowerCase().includes(e.toLowerCase())))?`г. ${t}, ${o.district},  ${o.address}`:`г. ${t},  ${o.address}`}function m(e){return e.replace(/\D/g,"")}class g{constructor(e){this.sheet=e,this.sheetRowCursor=1}setColumns(e){e.forEach((e=>{const{name:t,width:o}=e;this.sheet.column(t).width(o)}))}createRow(e,t,o=[]){let n=this.sheet.row(e).cell(1);return t.forEach(((e,t)=>{const{value:s,colSpan:r}=e,l=Object.assign({border:!0},o[t]);n=r?n.rangeTo(n.relativeCell(0,r-1)).merged(!0).value(s).style(l).endCell().relativeCell(0,1):n.value(s).style(l).relativeCell(0,1)})),n}createRouteSheetBlock({startRowIndex:e,date:t,time:o,employees:n,employeeOnDutyPhoneNumber:s,index:r}){this.createRow(e,[{value:`Маршрутный лист "БИЛАЙН" №${r}`,colSpan:4}],[{bold:!0,fill:"d3d3d3",horizontalAlignment:"center"}]),this.createRow(++e,[{value:"Дата исполнения заказа:",colSpan:2},{value:t,colSpan:2}],[{bold:!0}]),this.createRow(++e,[{value:"Время посадки:",colSpan:2},{value:o,colSpan:2}],[{bold:!0}]),this.createRow(++e,[{value:"Номер телефона дежурного:",colSpan:2},{value:s,colSpan:2}],[{bold:!0}]),this.createRow(++e,[{value:"Номер заказа:",colSpan:2},{value:"",colSpan:2}],[{bold:!0}]),this.createRow(++e,[{value:"ФИО"},{value:"Улица"},{value:"Район",colSpan:2}],[{bold:!0,fill:"d3d3d3",horizontalAlignment:"center"},{bold:!0,fill:"d3d3d3",horizontalAlignment:"center"},{bold:!0,fill:"d3d3d3",horizontalAlignment:"center"}]),n.forEach((t=>{const o=this.createRow(++e,[{value:d(t.fullName)},{value:`${t.address}, ${t.phone}`},{value:t.district,colSpan:2}]).rowNumber();this.sheetRowCursor=o+1}))}}const f=({errorHelpText:e,formGroup:t,icon:o,touched:n,validity:s,isForced:r=!1})=>{const l=document.querySelector(".modal-dialog");!n&&!r||s.valid&&!s.valueMissing?(t.classList.remove("has-error"),t.classList.add("has-success"),o.classList.add("glyphicon-ok"),o.classList.remove("glyphicon-remove"),e.innerText="",l.dispatchEvent(new CustomEvent("phoneValidationResult",{detail:{isValid:!0}}))):(t.classList.remove("has-success"),t.classList.add("has-error"),o.classList.remove("glyphicon-ok"),o.classList.add("glyphicon-remove"),e.innerText=s.valueMissing?"Телефон обязателен для заполнения":"Введите телефон в формате +7-999-999-99-99",l.dispatchEvent(new CustomEvent("phoneValidationResult",{detail:{isValid:!1}})))};let b,y;ymaps.ready((function(){!function(){const e=document.querySelector(".loader"),t=document.querySelector(".page-wrapper.container");e.classList.add("hidden"),t.classList.remove("hidden")}(),function(){b=new ymaps.Map("map",{center:t,zoom:12}),ymaps.templateLayoutFactory.createClass("<h2 class=ballon_header>{{ properties.balloonContentHeader|raw }}</h2><div class=ballon_body>{{ properties.balloonContentBody|raw }}</div>");const e=ymaps.templateLayoutFactory.createClass(["<ul class='cluster-list'>","{% for geoObject in properties.geoObjects %}",'<li><a href=# data-placemarkid="{{ geoObject.properties.placemarkId }}" class="list_item">{{ geoObject.properties.balloonContentHeader|raw }}</a></li>',"{% endfor %}","</ul>"].join(""));$(document).on("click",".cluster-item-add-to-route-sheet input",(e=>{const t=+m(e.target.id);b.geoObjects.get(t);const o=b.geoObjects.get(1).getGeoObjects().find((e=>+m(e.properties.get("id"))===t));S(o)||4!==w.length||e.preventDefault(),o.events.fire("click")})),y=new ymaps.Clusterer({preset:"islands#invertedVioletClusterIcons",groupByCoordinates:!0,clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!0,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,clusterHasHint:!0,clusterOpenHintOnHover:!0,clusterOpenEmptyHint:!0,clusterHintContent:"123",clusterBalloonContentLayout:e},{clusterHintContent:"123"}),y.createCluster=function(e,t){let o=ymaps.Clusterer.prototype.createCluster.call(this,e,t);o.getGeoObjects().length;let n=t[0].getAddressLine().split(",");return n.shift(),n=n.join(","),o.properties.set("hintContent",n),o.events.add(["click"],(e=>{e.originalEvent.target.getGeoObjects().forEach((e=>{const t=e.properties.get("employee"),o=+m(e.properties.get("id")),n=w.some((t=>e===t.geoObject));e.properties.set("balloonContentHeader",E(o,d(t.fullName),n))}))})),o},L(b)}(),function(){const t=$("#viewEditorBtn");let n=$("#cke_pasteTimeTableEditor"),i=$("#cke_routeSheets");const u=$("#viewTimeSelectorBtn"),m=$("#timeSelectorModal"),S=$("#send"),T=$(".remove-route"),H=$(".car-fill-progress-window"),B=$(".chart"),N=$("#add"),D=$("#download"),I=$("#modal-message"),V=p.bind(null,r,s);M=M.bind({chart:B,progressWindow:H}),A=A.bind({timeSelectorModal:m}),P=P.bind(I),j=j.bind(I),$('[data-toggle="tooltip"]').tooltip(),G=B,G.easyPieChart({easing:"easeOutBounce",onStep:function(e,t,o){$(this.el).find(".percent").text(Math.round(o))},barColor:"#68b3a5",trackColor:"#f2f2f2",scaleColor:!1,lineWidth:8,size:130,animate:500}),$("#voronezh").bind("click",(function(){haightAshbury=new ymaps.maps.LatLng(51.680647,39.180847),setMapOnAll(null),markers.splice(1,markers.length-1),markers[0].position=haightAshbury,markers[0].title="ЦПК г.Воронеж",markers[0].code="55.751574, 37.573856",setMapOnAll(map),map.setCenter(markers[0].getPosition())})),$("#nino").bind("click",(function(){haightAshbury=new ymaps.maps.LatLng(56.307438,43.988931),setMapOnAll(null),markers.splice(1,markers.length-1),markers[0].position=haightAshbury,markers[0].title="ЦПК г.Нижний Новгород",markers[0].code="55.751574, 37.573856",setMapOnAll(map),map.setCenter(markers[0].getPosition())})),$("#perm").bind("click",(function(){haightAshbury=new ymaps.maps.LatLng(58.009557,56.187656),setMapOnAll(null),markers.splice(1,markers.length-1),markers[0].position=haightAshbury,markers[0].title="ЦПК г.Пермь",markers[0].code="55.751574, 37.573856",setMapOnAll(map),map.setCenter(markers[0].getPosition())})),$("#map").height($(window).height()-$("#header-navbar").height()-$("#footer-bar").height()-20),t.bind("click",(function(){R(),h(this),m.hide(),n=0===n.length?$("#cke_pasteTimeTableEditor"):n,n.toggle(),i.hide(),$("#cke_1_contents").height($(window).height()-$("#header-navbar").height()-$("#footer-bar").height()-200)})),u.bind("click",(function(){R(),h(this),n.hide(),i.hide(),m.toggle()})),S.bind("click",e.debounce((function(){0!==b.geoObjects.getLength()&&(b.geoObjects.removeAll(),y.removeAll(),L(b),v=null);const e=function(e){const t=Array.from(e).find((e=>e.checked));return t?t.value:null}($("#timeSelectorModal input[type='radio']")),t=$("#cke_pasteTimeTableEditor iframe").contents().find("table > tbody > tr");if(!t.length)return void P({bodyText:"Таблица с информацией по сотрудниками не скопирована или таблица некорректного формата"});const o=Array.from(t).filter((t=>t.children[0].innerText.padStart(5,"0")===e));if(!o.length)return void P({bodyText:"Нет сотрудников, записанных на выбранное время"});const n=o.map((e=>Array.from(e.querySelectorAll("td")).map((e=>e.innerText)))).map(a).filter((e=>{const t=c(e);return!O.has(t)}));if(!n.length)return void P({bodyText:"На выбранное время уже сформированы маршрутные листы"});const s=n.map(V);n.forEach(((e,t)=>{ymaps.geocode(s[t]).then((o=>{const n=o.geoObjects.get(0);n.options.set("hasBalloon",!1),n.options.set("hasHint",!0),n.properties.set("balloonContentHeader",E(t,d(e.fullName))),n.properties.set("hintContent",s[t]),n.properties.set("id",`addressMark_${t}`),n.properties.set("employee",e),n.events.add(["click"],A(e,w)),y.add(n),b.geoObjects.add(y)})).catch((e=>console.error("При выполнении геокодирования возникла ошибка:",e)))}))}),500)),T.bind("click",(function(){k.setReferencePoints([o]),M();b.geoObjects.get(1).getGeoObjects().forEach((e=>{e.options.set("preset","islands#blueIcon")})),w.length=0})),N.on("click",(()=>{if(w.length){for(C.push([...w]),w.forEach((e=>{const t=c(e);O.add(t)}));w.length;){const e=w[0];y.remove(e.geoObject),w.shift()}k.setReferencePoints([o]),M()}}));var G;const _=()=>{if(console.log({exportExcelFile:_}),!C.length)return console.log("!routeSheetsData.length"),void P({title:"Ошибка при выгрузке",bodyText:"Нельзя выгрузить пустые маршрутные листы. Необходимо выбрать адреса поездок."});console.log({globalState:x}),XlsxPopulate.fromBlankAsync().then((e=>{const t=new g(e.sheet("Sheet1"));t.setColumns([{name:"A",width:18},{name:"B",width:44.14},{name:"C",width:15.42}]);let o=l,n=!0;return C.forEach(((e,s)=>{if(!e.length)return;const r=6+e.length+(n?0:1);r>o&&(t.sheetRowCursor=Math.round(t.sheetRowCursor/l)*l+1,n=!0,o=l),o-=r,t.createRouteSheetBlock({startRowIndex:t.sheetRowCursor+(n?0:1),date:(new Date).toLocaleDateString(),time:e[0].rideTime,employees:e,index:s+1,employeeOnDutyPhoneNumber:x.employeeOnDutyPhoneNumber}),n=!1})),e.outputAsync()})).then((function(e){const t=`Маршрутные листы ${function(e=new Date){return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`}(new Date)}.xlsx`,o=window.URL.createObjectURL(e);let n=document.createElement("a");document.body.appendChild(n),n.href=o,n.download=t,n.click(),window.URL.revokeObjectURL(o),document.body.removeChild(n)})).catch((function(e){throw alert(e.message||e),e}))};D.on("click",(()=>{const e=(e=>{let t=!1;const o=document.createElement("div");o.classList.add("form-group","has-feedback");const n=document.createElement("span");n.classList.add("glyphicon","glyphicon-remove","form-control-feedback");const s=document.createElement("div");s.classList.add("phone-error-text","text-danger");const r=document.createElement("input");return r.autofocus=!0,r.type="tel",r.pattern="^((\\+7)|8)-[0-9]{3}-[0-9]{3}-[0-9]{2}-[0-9]{2}$",r.title="Введите телефон в формате +7-999-999-99-99",r.required=!0,r.classList.add("form-control"),new Cleave(r,{blocks:[2,3,3,2,2],prefix:"+7",numericOnly:!0,delimiter:"-"}),r.addEventListener("input",(r=>{e.employeeOnDutyPhoneNumber=r.target.value,f({errorHelpText:s,formGroup:o,icon:n,touched:t,validity:r.target.validity})})),r.addEventListener("blur",(e=>{t=!0,f({errorHelpText:s,formGroup:o,icon:n,touched:t,validity:e.target.validity})})),r.addEventListener("runPhoneValidation",(e=>{t=!0,f({errorHelpText:s,formGroup:o,icon:n,touched:t,validity:e.target.validity,isForced:!0})})),o.appendChild(r),o.appendChild(n),o.appendChild(s),o})(x),t=()=>(console.log("handleExportExcelFile"),console.log("formGroupElement.querySelector('input')",e.querySelector("input")),new Promise(((t,o)=>{const n=document.querySelector(".modal-dialog"),s=e=>{console.log("message.on phoneValidationResult",e),e.detail.isValid?t(!0):o(),n.removeEventListener("phoneValidationResult",s)};n.addEventListener("phoneValidationResult",s),e.querySelector("input").dispatchEvent(new CustomEvent("runPhoneValidation"))})).then(_));P({title:"Телефон дежурного",bodyContent:e,footerButtons:[{text:"Отмена"},{text:"Выгрузить",classNames:"btn-excel-export",onClick:t}]})}))}()}));let v=null,k=null,w=[],C=[],O=new Set,x={employeeOnDutyPhoneNumber:"",hasPhoneError:!1};const S=e=>w.some((t=>t.geoObject===e)),E=(e,t,o=!1)=>{const n=`checkbox-add-to-route-sheet-${e}`;return`<div class='cluster-item-add-to-route-sheet'><input id=${n} type='checkbox' ${o?"checked":""}/><label for=${n}>${t}</label></div>`},L=e=>{e.geoObjects.add(new ymaps.Placemark(n,{balloonContent:"<strong>ЦПК Калуга</strong>",hintContent:"ЦПК Калуга"},{iconColor:"#ff0000"}))};function R(){$(".nav-stacked li").removeClass("active")}function A(e,t){return function(n){const s=n.get("target"),r=s.geometry.getCoordinates();if(this.timeSelectorModal.hide(),!v){const n=[o,r];k=new ymaps.multiRouter.MultiRouteModel(n),v=new ymaps.multiRouter.MultiRoute(k,{wayPointIconFillColor:"red",wayPointVisible:!1,boundsAutoApply:!1}),console.log({currentMultiRoute:v}),b.geoObjects.add(v),s.options.set("preset","islands#darkGreenIcon");const l=u(e,s);return t.push(l),void M()}let l=k.getReferencePoints();const a=S(s);if(a||5!==l.length){if(a){const o=l.findIndex((e=>!!Array.isArray(e)&&(r[0]===e[0]&&r[1]===e[1])));l.splice(o,1),s.options.set("preset","islands#blueIcon");const n=t.findIndex((t=>{return o=t,n=e,i.every((e=>o[e]===n[e]));var o,n}));t.splice(n,1)}else{l.push(r),s.options.set("preset","islands#darkGreenIcon");const o=u(e,s);t.push(o)}k.setReferencePoints(l),console.log({currentMultiRoute:v}),M()}else alert("нельзя добавить в одну машину больше 4 пассажиров!")}.bind(this)}function M(){const e=k.getReferencePoints();this.progressWindow.css({display:e.length>1?"block":"none"});const t=25*(e.length-1);this.chart.data("easyPieChart").update(t)}function j(){const e=this.find(".modal-body"),t=this.find(".modal-footer");e.empty(),console.log("hideMessageModal before display: 'none'"),this.css({display:"none"}),t.empty()}function P({title:e,bodyText:t="",bodyContent:o,onClose:n,footerButtons:s=[{text:"Закрыть"}]}){console.log("showMessageModal"),this.removeClass("fade"),console.log("showMessageModal before display: 'block'"),this.css({display:"block"}),this.find(".modal-dialog");const r=this.find(".modal-title"),l=this.find(".modal-body"),i=this.find(".modal-header"),a=this.find(".modal-footer");this.find(".modal-footer button");const c=this.find(".modal-header button");e&&r.text(e),r.css({display:e?"block":"none"}),e?i.removeClass("no-border-bottom"):i.addClass("no-border-bottom"),o?l.append(o):l.text(t),c.on("click",j),a.empty(),s.forEach(((e,t)=>{const o=$(document.createElement("button"));o.attr("type","button"),o.attr("class",e.classNames?"btn btn-default":`btn btn-default ${e.classNames}`),o.text(e.text),o.on("click",(async()=>{try{await("function"==typeof e.onClick?e.onClick():Promise.resolve(!0))&&j()}catch(e){console.log("error",e)}})),a.append(o)}))}}(_);
